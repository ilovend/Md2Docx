#!/bin/bash
# ============================================================================
# pre-commit hook
# 检查代码变更是否包含 docs 链接
# ============================================================================

echo "Running pre-commit hook..."

# 获取暂存的文件
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# 如果没有暂存文件，直接通过
if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# 检查是否有代码文件变更
CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(py|ts|tsx|js|jsx)$' || true)

if [ -n "$CODE_FILES" ]; then
    # 获取提交信息 (仅用于检查，不会阻止提交)
    echo "检测到代码文件变更:"
    echo "$CODE_FILES"
    echo ""
    echo "提示：请确保提交信息或 PR 中包含相关文档链接"
    echo "格式示例："
    echo "  - 关联文档: docs/design/DESIGN-XXX.md"
    echo "  - ADR: docs/decisions/adr/XXXX.md"
    echo ""
fi

# 检查 docs 目录是否有变更
DOCS_FILES=$(echo "$STAGED_FILES" | grep -E '^docs/' || true)

if [ -n "$DOCS_FILES" ]; then
    # 检查 docs/index.md 是否也在变更中
    if ! echo "$STAGED_FILES" | grep -q "docs/index.md"; then
        echo "⚠️  警告：docs 目录有变更，请确认是否需要更新 docs/index.md"
        echo "变更的文档文件:"
        echo "$DOCS_FILES"
        echo ""
    fi
fi

# 运行基本的语法检查
echo "运行语法检查..."

# Python 语法检查
PY_FILES=$(echo "$STAGED_FILES" | grep '\.py$' || true)
if [ -n "$PY_FILES" ]; then
    for file in $PY_FILES; do
        if [ -f "$file" ]; then
            if ! python -m py_compile "$file" 2>/dev/null; then
                echo "❌ Python 语法错误: $file"
                exit 1
            fi
        fi
    done
    echo "✓ Python 语法检查通过"
fi

echo "✓ pre-commit 检查完成"
exit 0
