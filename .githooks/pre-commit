#!/bin/bash
# ============================================================================
# pre-commit hook
# 检查代码变更是否包含 docs 链接
# ============================================================================

echo "Running pre-commit hook..."

# 获取暂存的文件
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# 如果没有暂存文件，直接通过
if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# 检查是否有代码文件变更
CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(py|ts|tsx|js|jsx)$' || true)

if [ -n "$CODE_FILES" ]; then
    # 获取提交信息 (仅用于检查，不会阻止提交)
    echo "检测到代码文件变更:"
    echo "$CODE_FILES"
    echo ""
    echo "提示：请确保提交信息或 PR 中包含相关文档链接"
    echo "格式示例："
    echo "  - 关联文档: docs/design/DESIGN-XXX.md"
    echo "  - ADR: docs/decisions/adr/XXXX.md"
    echo ""
fi

# 检查 docs 目录是否有变更
DOCS_FILES=$(echo "$STAGED_FILES" | grep -E '^docs/' || true)

if [ -n "$DOCS_FILES" ]; then
    # 检查 docs/index.md 是否也在变更中
    if ! echo "$STAGED_FILES" | grep -q "docs/index.md"; then
        echo "⚠️  警告：docs 目录有变更，请确认是否需要更新 docs/index.md"
        echo "变更的文档文件:"
        echo "$DOCS_FILES"
        echo ""
    fi
fi

# 代码格式化检查
echo -e "\n运行代码格式化检查..."

# 前端代码格式化
FRONTEND_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json|yaml|yml|md)$' || true)
if [ -n "$FRONTEND_FILES" ] && [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
    echo -e "\n[1/2] 前端代码格式化..."
    cd frontend
    if command -v npx &> /dev/null; then
        echo "  运行 Prettier 格式化..."
        npx prettier --write .
        if [ $? -eq 0 ]; then
            echo "  ✓ 前端代码格式化完成"
            # 将格式化后的文件重新添加到暂存区
            git add .
        else
            echo "  ⚠️  前端代码格式化失败，但不阻止提交"
        fi
    else
        echo "  ⚠️  npx 未找到，跳过前端格式化"
    fi
    cd ..
fi

# Python 代码格式化
PY_FILES=$(echo "$STAGED_FILES" | grep '\.py$' || true)
if [ -n "$PY_FILES" ]; then
    echo -e "\n[2/2] Python 代码格式化..."
    if command -v python &> /dev/null && python -m black --version &> /dev/null; then
        echo "  运行 Black 格式化..."
        python -m black .
        if [ $? -eq 0 ]; then
            echo "  ✓ Python 代码格式化完成"
            # 将格式化后的文件重新添加到暂存区
            git add .
        else
            echo "  ⚠️  Python 代码格式化失败，但不阻止提交"
        fi
    else
        echo "  ⚠️  Black 未安装，跳过Python格式化"
    fi
fi

# 运行基本的语法检查
echo -e "\n运行语法检查..."

# Python 语法检查
if [ -n "$PY_FILES" ]; then
    for file in $PY_FILES; do
        if [ -f "$file" ]; then
            if ! python -m py_compile "$file" 2>/dev/null; then
                echo "❌ Python 语法错误: $file"
                exit 1
            fi
        fi
    done
    echo "✓ Python 语法检查通过"
fi

echo "✓ pre-commit 检查完成"
exit 0
